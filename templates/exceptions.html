{% extends "layout.html" %}

{% block title %}Alert Exceptions - VigilantRaccoon{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Alert Exceptions</h1>
    <p class="text-muted">Configure alert filtering rules to reduce false positives</p>
</div>

<div class="card">
    <div class="card-header">
        <h3>Add New Exception</h3>
    </div>
    <div class="card-body">
        <form id="addExceptionForm">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="ruleType" class="form-label">Rule Type</label>
                        <select id="ruleType" name="rule_type" class="form-select" required>
                            <option value="">Select Rule Type</option>
                            <option value="ip">IP Address</option>
                            <option value="username">Username</option>
                            <option value="server">Server Name</option>
                            <option value="log_source">Log Source</option>
                            <option value="rule_pattern">Rule Pattern</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="ruleValue" class="form-label">Value</label>
                        <input type="text" id="ruleValue" name="value" class="form-control" required>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="ruleDescription" class="form-label">Description</label>
                        <input type="text" id="ruleDescription" name="description" class="form-control" required>
                    </div>
                </div>
            </div>
            
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">Add Exception</button>
                <button type="reset" class="btn btn-secondary">Reset Form</button>
            </div>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3>Configured Exceptions</h3>
        <button id="refreshExceptionsBtn" class="btn btn-primary">Refresh</button>
    </div>
    <div class="card-body">
        <div id="exceptionsList">
            <div class="text-center text-muted">Loading exceptions...</div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3>Exception Types</h3>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Description</th>
                        <th>Example</th>
                        <th>Use Case</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>ip</code></td>
                        <td>Filter alerts by IP address</td>
                        <td><code>192.168.1.100</code></td>
                        <td>Ignore alerts from trusted IPs</td>
                    </tr>
                    <tr>
                        <td><code>username</code></td>
                        <td>Filter alerts by username</td>
                        <td><code>admin</code></td>
                        <td>Ignore alerts from trusted users</td>
                    </tr>
                    <tr>
                        <td><code>server</code></td>
                        <td>Filter alerts by server name</td>
                        <td><code>web-server</code></td>
                        <td>Ignore alerts from specific servers</td>
                    </tr>
                    <tr>
                        <td><code>log_source</code></td>
                        <td>Filter alerts by log source</td>
                        <td><code>journal:ssh</code></td>
                        <td>Ignore specific log sources</td>
                    </tr>
                    <tr>
                        <td><code>rule_pattern</code></td>
                        <td>Filter alerts by rule pattern</td>
                        <td><code>sshd_accepted</code></td>
                        <td>Ignore specific alert types</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let exceptions = [];

document.addEventListener('DOMContentLoaded', function() {
    loadExceptions();
    setupEventListeners();
});

function setupEventListeners() {
    document.getElementById('addExceptionForm').addEventListener('submit', addException);
    document.getElementById('refreshExceptionsBtn').addEventListener('click', loadExceptions);
}

async function addException(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const exceptionData = {
        rule_type: formData.get('rule_type'),
        value: formData.get('value'),
        description: formData.get('description')
    };
    
    try {
        const response = await fetch('/api/exceptions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(exceptionData)
        });
        
        if (response.ok) {
            alert('Exception added successfully!');
            event.target.reset();
            loadExceptions();
        } else {
            const error = await response.text();
            throw new Error(error || 'Failed to add exception');
        }
    } catch (error) {
        console.error('Error adding exception:', error);
        alert('Failed to add exception: ' + error.message);
    }
}

async function loadExceptions() {
    try {
        const response = await fetch('/api/exceptions');
        if (response.ok) {
            exceptions = await response.json();
            displayExceptions();
        } else {
            throw new Error('Failed to load exceptions');
        }
    } catch (error) {
        console.error('Error loading exceptions:', error);
        document.getElementById('exceptionsList').innerHTML = '<div class="text-center text-danger">Failed to load exceptions</div>';
    }
}

function displayExceptions() {
    const container = document.getElementById('exceptionsList');
    
    if (exceptions.length === 0) {
        container.innerHTML = '<div class="text-center text-muted">No exceptions configured</div>';
        return;
    }
    
    container.innerHTML = exceptions.map(exception => `
        <div class="card mb-3">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h5 class="card-title">${escapeHtml(exception.description)}</h5>
                        <p class="card-text">
                            <strong>Type:</strong> <code>${exception.rule_type}</code><br>
                            <strong>Value:</strong> <code>${escapeHtml(exception.value)}</code>
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-danger btn-sm" onclick="deleteException(${exception.id})">Delete</button>
                        <button class="btn btn-info btn-sm" onclick="editException(${exception.id})">Edit</button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

async function deleteException(exceptionId) {
    if (!confirm('Are you sure you want to delete this exception?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/exceptions/${exceptionId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            alert('Exception deleted successfully!');
            loadExceptions();
        } else {
            throw new Error('Failed to delete exception');
        }
    } catch (error) {
        console.error('Error deleting exception:', error);
        alert('Failed to delete exception: ' + error.message);
    }
}

function editException(exceptionId) {
    const exception = exceptions.find(e => e.id === exceptionId);
    if (!exception) {
        alert('Exception not found');
        return;
    }
    
    // Populate form for editing
    document.getElementById('ruleType').value = exception.rule_type;
    document.getElementById('ruleValue').value = exception.value;
    document.getElementById('ruleDescription').value = exception.description;
    
    // Change form to update mode
    const form = document.getElementById('addExceptionForm');
    const submitBtn = form.querySelector('button[type="submit"]');
    
    submitBtn.textContent = 'Update Exception';
    submitBtn.className = 'btn btn-success';
    
    // Store the exception ID for updating
    form.dataset.editId = exceptionId;
    
    // Scroll to form
    form.scrollIntoView({ behavior: 'smooth' });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
