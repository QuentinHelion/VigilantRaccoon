{% extends "layout.html" %}

{% block title %}Settings - VigilantRaccoon{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Application Settings</h1>
    <p class="text-muted">Configure system settings and monitoring parameters</p>
</div>

<div class="card">
    <div class="card-header">
        <h3>Collection Settings</h3>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="pollInterval" class="form-label">Poll Interval (seconds)</label>
                    <input type="number" id="pollInterval" class="form-control" value="60" min="10" max="3600">
                    <div class="help-text">How often to check for new logs (10-3600 seconds)</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="tailLines" class="form-label">Tail Lines</label>
                    <input type="number" id="tailLines" class="form-control" value="2000" min="100" max="10000">
                    <div class="help-text">Number of lines to read from log files (100-10000)</div>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="ignoreSourceIPs" class="form-label">Ignore Source IPs</label>
            <textarea id="ignoreSourceIPs" class="form-control" rows="3" placeholder="Enter IP addresses to ignore, one per line&#10;Example:&#10;127.0.0.1&#10;192.168.1.100"></textarea>
            <div class="help-text">IP addresses to exclude from monitoring (one per line)</div>
        </div>
        
        <div class="d-flex gap-2">
            <button id="triggerCollectionBtn" class="btn btn-primary">Trigger Collection Now</button>
            <button id="showDebugBtn" class="btn btn-info">Show Collection Debug</button>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3>Email Notification Settings</h3>
    </div>
    <div class="card-body">
        <div class="form-check mb-3">
            <input type="checkbox" id="emailEnabled" class="form-check-input">
            <label for="emailEnabled" class="form-check-label">Enable Email Notifications</label>
        </div>
        
        <div id="emailSettings" class="d-none">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="smtpHost" class="form-label">SMTP Host</label>
                        <input type="text" id="smtpHost" class="form-control" placeholder="smtp.gmail.com">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="smtpPort" class="form-label">SMTP Port</label>
                        <input type="number" id="smtpPort" class="form-control" value="587" min="1" max="65535">
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="smtpUsername" class="form-label">SMTP Username</label>
                        <input type="text" id="smtpUsername" class="form-control" placeholder="your_email@gmail.com">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="smtpPassword" class="form-label">SMTP Password</label>
                        <input type="password" id="smtpPassword" class="form-control" placeholder="App password or account password">
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="fromAddress" class="form-label">From Address</label>
                        <input type="email" id="fromAddress" class="form-control" placeholder="alerts@yourdomain.com">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="toAddresses" class="form-label">To Addresses</label>
                        <textarea id="toAddresses" class="form-control" rows="2" placeholder="Enter email addresses, one per line&#10;Example:&#10;admin@yourdomain.com&#10;security@yourdomain.com"></textarea>
                    </div>
                </div>
            </div>
            
            <div class="form-check mb-3">
                <input type="checkbox" id="useTLS" class="form-check-input" checked>
                <label for="useTLS" class="form-check-label">Use TLS/SSL</label>
            </div>
            
            <button id="testEmailBtn" class="btn btn-success">Test Email Configuration</button>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3>Logging Settings</h3>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label for="logLevel" class="form-label">Log Level</label>
                    <select id="logLevel" class="form-select">
                        <option value="DEBUG">DEBUG</option>
                        <option value="INFO" selected>INFO</option>
                        <option value="WARNING">WARNING</option>
                        <option value="ERROR">ERROR</option>
                    </select>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="logFile" class="form-label">Log File Path</label>
                    <input type="text" id="logFile" class="form-control" value="./logs/app.log">
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="consoleLogging" class="form-label">Console Logging</label>
                    <select id="consoleLogging" class="form-select">
                        <option value="true" selected>Enabled</option>
                        <option value="false">Disabled</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="dailyRotation" class="form-label">Daily Log Rotation</label>
                    <select id="dailyRotation" class="form-select">
                        <option value="true" selected>Enabled</option>
                        <option value="false">Disabled</option>
                    </select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="retentionDays" class="form-label">Retention Days</label>
                    <input type="number" id="retentionDays" class="form-control" value="30" min="1" max="365">
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3>Web Interface Settings</h3>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="webHost" class="form-label">Host</label>
                    <input type="text" id="webHost" class="form-control" value="0.0.0.0">
                    <div class="help-text">Use 0.0.0.0 to bind to all interfaces</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="webPort" class="form-label">Port</label>
                    <input type="number" id="webPort" class="form-control" value="8000" min="1" max="65535">
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3>Actions</h3>
    </div>
    <div class="card-body">
        <div class="d-flex gap-2">
            <button id="saveSettingsBtn" class="btn btn-primary">Save Settings</button>
            <button id="resetSettingsBtn" class="btn btn-secondary">Reset to Defaults</button>
            <button id="exportSettingsBtn" class="btn btn-info">Export Configuration</button>
        </div>
    </div>
</div>

<div id="debugOutput" class="card d-none">
    <div class="card-header">
        <h3>Collection Debug Output</h3>
    </div>
    <div class="card-body">
        <pre id="debugContent" class="bg-light p-3 rounded"></pre>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadSettings();
    setupEventListeners();
});

function setupEventListeners() {
    document.getElementById('emailEnabled').addEventListener('change', toggleEmailSettings);
    document.getElementById('triggerCollectionBtn').addEventListener('click', triggerCollection);
    document.getElementById('showDebugBtn').addEventListener('click', showCollectionDebug);
    document.getElementById('testEmailBtn').addEventListener('click', testEmailConfiguration);
    document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
    document.getElementById('resetSettingsBtn').addEventListener('click', resetSettings);
    document.getElementById('exportSettingsBtn').addEventListener('click', exportConfiguration);
}

function toggleEmailSettings() {
    const emailSettings = document.getElementById('emailSettings');
    const isEnabled = document.getElementById('emailEnabled').checked;
    
    if (isEnabled) {
        emailSettings.classList.remove('d-none');
    } else {
        emailSettings.classList.add('d-none');
    }
}

async function loadSettings() {
    try {
        const response = await fetch('/api/settings');
        if (response.ok) {
            const settings = await response.json();
            populateSettingsForm(settings);
        } else {
            console.error('Failed to load settings');
        }
    } catch (error) {
        console.error('Error loading settings:', error);
    }
}

function populateSettingsForm(settings) {
    // Collection settings
    document.getElementById('pollInterval').value = settings.poll_interval_seconds || 60;
    document.getElementById('tailLines').value = settings.collection?.tail_lines || 2000;
    document.getElementById('ignoreSourceIPs').value = (settings.collection?.ignore_source_ips || []).join('\n');
    
    // Email settings
    document.getElementById('emailEnabled').checked = settings.email?.enabled || false;
    document.getElementById('smtpHost').value = settings.email?.smtp_host || '';
    document.getElementById('smtpPort').value = settings.email?.smtp_port || 587;
    document.getElementById('smtpUsername').value = settings.email?.username || '';
    document.getElementById('smtpPassword').value = settings.email?.password || '';
    document.getElementById('fromAddress').value = settings.email?.from_addr || '';
    document.getElementById('toAddresses').value = (settings.email?.to_addrs || []).join('\n');
    document.getElementById('useTLS').checked = settings.email?.use_tls !== false;
    
    // Logging settings
    document.getElementById('logLevel').value = settings.logging?.level || 'INFO';
    document.getElementById('logFile').value = settings.logging?.file_path || './logs/app.log';
    document.getElementById('consoleLogging').value = settings.logging?.console?.toString() || 'true';
    document.getElementById('dailyRotation').value = settings.logging?.daily_rotation?.toString() || 'true';
    document.getElementById('retentionDays').value = settings.logging?.retention_days || 30;
    
    // Web settings
    document.getElementById('webHost').value = settings.web?.host || '0.0.0.0';
    document.getElementById('webPort').value = settings.web?.port || 8000;
    
    toggleEmailSettings();
}

async function saveSettings() {
    const settings = {
        poll_interval_seconds: parseInt(document.getElementById('pollInterval').value),
        collection: {
            tail_lines: parseInt(document.getElementById('tailLines').value),
            ignore_source_ips: document.getElementById('ignoreSourceIPs').value.split('\n').filter(ip => ip.trim())
        },
        email: {
            enabled: document.getElementById('emailEnabled').checked,
            smtp_host: document.getElementById('smtpHost').value,
            smtp_port: parseInt(document.getElementById('smtpPort').value),
            username: document.getElementById('smtpUsername').value,
            password: document.getElementById('smtpPassword').value,
            from_addr: document.getElementById('fromAddress').value,
            to_addrs: document.getElementById('toAddresses').value.split('\n').filter(email => email.trim()),
            use_tls: document.getElementById('useTLS').checked
        },
        logging: {
            level: document.getElementById('logLevel').value,
            file_path: document.getElementById('logFile').value,
            console: document.getElementById('consoleLogging').value === 'true',
            daily_rotation: document.getElementById('dailyRotation').value === 'true',
            retention_days: parseInt(document.getElementById('retentionDays').value)
        },
        web: {
            host: document.getElementById('webHost').value,
            port: parseInt(document.getElementById('webPort').value)
        }
    };
    
    try {
        const response = await fetch('/api/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(settings)
        });
        
        if (response.ok) {
            alert('Settings saved successfully!');
        } else {
            throw new Error('Failed to save settings');
        }
    } catch (error) {
        console.error('Error saving settings:', error);
        alert('Failed to save settings: ' + error.message);
    }
}

async function resetSettings() {
    if (!confirm('Are you sure you want to reset all settings to defaults?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/settings/reset', { method: 'POST' });
        if (response.ok) {
            alert('Settings reset to defaults!');
            loadSettings();
        } else {
            throw new Error('Failed to reset settings');
        }
    } catch (error) {
        console.error('Error resetting settings:', error);
        alert('Failed to reset settings: ' + error.message);
    }
}

async function exportConfiguration() {
    try {
        const response = await fetch('/api/settings/export');
        if (response.ok) {
            const config = await response.text();
            
            // Create download link
            const blob = new Blob([config], { type: 'text/yaml' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'vigilant_raccoon_config.yaml';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        } else {
            throw new Error('Failed to export configuration');
        }
    } catch (error) {
        console.error('Error exporting configuration:', error);
        alert('Failed to export configuration: ' + error.message);
    }
}

async function triggerCollection() {
    try {
        const response = await fetch('/api/collection/trigger', { method: 'POST' });
        if (response.ok) {
            alert('Collection triggered successfully!');
        } else {
            throw new Error('Failed to trigger collection');
        }
    } catch (error) {
        console.error('Error triggering collection:', error);
        alert('Failed to trigger collection: ' + error.message);
    }
}

async function showCollectionDebug() {
    try {
        const response = await fetch('/api/collection/debug');
        if (response.ok) {
            const debugInfo = await response.text();
            document.getElementById('debugContent').textContent = debugInfo;
            document.getElementById('debugOutput').classList.remove('d-none');
        } else {
            throw new Error('Failed to get debug information');
        }
    } catch (error) {
        console.error('Error getting debug information:', error);
        alert('Failed to get debug information: ' + error.message);
    }
}

async function testEmailConfiguration() {
    try {
        const response = await fetch('/api/email/test', { method: 'POST' });
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                alert('Test email sent successfully!');
            } else {
                alert('Test email failed: ' + result.message);
            }
        } else {
            throw new Error('Failed to send test email');
        }
    } catch (error) {
        console.error('Error sending test email:', error);
        alert('Failed to send test email: ' + error.message);
    }
}
</script>
{% endblock %}
